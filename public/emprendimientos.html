<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emprendimientos - Red Social Universitaria</title>
    <link rel="stylesheet" href="css/emprendimientos.css">
</head>
<body>
    <div class="header">
        <img src="images/SIMBO.png" width="4.5%" height="143%" >
        <div class="nav-icons">
            <div class="nav-icon active">
                <a href="index.html">
                    <img src="images/hogar.png" width="100%" alt="Home">
                </a>
            </div>
            <div class="nav-icon">
                <img src="images/tocar.png" alt="Videos">
            </div>
            <div class="nav-icon">
                <img src="images/bolsa-de-la-compra.png" alt="Marketplace">
            </div>
            <div class="nav-icon">
                <a href="sistemas2.html">
                    <img src="images/usuarios-alt.png" alt="Groups">
                </a>
            </div>
            <div class="nav-icon">
                <img src="images/siguiendo.png" alt="Games">
            </div>
        </div>
        <div class="search-container">
            <form action="/buscar" method="GET">
                <input type="text" class="search-box" name="codigo" placeholder="Buscar...">
            </form>
            <div class="message-container" onclick="location.href='/messages'">
                <img src="images/mensaje.png" width="30" height="30" alt="Mensajes" class="message-icon">
                <span id="message-count" class="message-count">0</span>
            </div>
            <a href="perfil.html" class="profile-link">
                <img id="header-photo" src="images/usuario.png" width="60" height="60" alt="Perfil" class="profile-icon">
            </a>
        </div>
        <div class="logout-container" onclick="logout()">
            <img src="images/salida 3.png" alt="Cerrar sesión" width="30" height="30">
        </div>
    </div>
    <div class="main-container">
        
        
       


        <div class="content">
            <h2>★ &nbsp; &nbsp;  Emprendimientos</h2> &nbsp;
            <div id="posts-container"></div>
        </div>
       
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        async function getCurrentUser() {
            try {
                const response = await fetch('/usuario');
                if (response.ok) {
                    return await response.json();
                } else {
                    alert('Error al cargar los datos del usuario');
                    return null;
                }
            } catch (error) {
                alert('Error al cargar los datos del usuario');
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const socket = io();
            const currentUser = await getCurrentUser();

            if (!currentUser) return; // Si no se pudo cargar el usuario, no continuar

            const postsContainer = document.getElementById('posts-container');

            socket.on('new post', (post) => {
                if (post.category === 'emprendimientos') {
                    addPostToDOM(post);
                }
            });

            socket.on('new comment', ({ postId, comment }) => {
                addCommentToDOM(postId, comment);
            });

            socket.on('new message', (message) => {
                addNotification(message);
            });

            function addPostToDOM(post) {
                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.innerHTML = `
                    <div class="post-header">
                        <img class="profile-pic" src="images/usuario.png" alt="Perfil">
                        <div>
                            <a href="perfil.html?codigo=${post.codigo}" class="post-username">${post.user}</a>
                            <span class="post-timestamp">${new Date(post.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                    <p>${post.text}</p>
                    ${post.image ? `<img src="${post.image}" alt="Imagen de la publicación">` : ''}
                    <div class="comments" id="comments-${post._id}">
                        ${post.comments.slice(0, 3).map(comment => `
                            <div class="comment">
                                <p>${comment.user}: ${comment.text}</p>
                                <span>${new Date(comment.timestamp).toLocaleString()}</span>
                            </div>
                        `).join('')}
                        ${post.comments.length > 3 ? `<div class="show-more" data-post-id="${post._id}">Mostrar más</div>` : ''}
                    </div>
                    <form class="comment-form" data-post-id="${post._id}">
                        <input type="text" name="comment" placeholder="Escribe un comentario...">
                        <button type="submit">Comentar</button>
                    </form>
                `;
                postsContainer.prepend(postElement);

                const commentForms = document.querySelectorAll('.comment-form');
                commentForms.forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const postId = form.getAttribute('data-post-id');
                        const commentText = form.querySelector('input[name="comment"]').value;

                        const response = await fetch(`/addComment/${postId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ user: currentUser.nombre + ' ' + currentUser.apellido, text: commentText })
                        });

                        if (response.ok) {
                            const comment = await response.json();
                            addCommentToDOM(postId, comment);
                            socket.emit('new comment', { postId, comment });
                            form.querySelector('input[name="comment"]').value = ''; // Limpiar el campo de comentario
                        } else {
                            alert('Error al comentar');
                        }
                    });
                });

                const showMoreButtons = document.querySelectorAll('.show-more');
                showMoreButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const postId = button.getAttribute('data-post-id');
                        const commentsContainer = document.getElementById(`comments-${postId}`);
                        const hiddenComments = post.comments.slice(3).map(comment => `
                            <div class="comment">
                                <p>${comment.user}: ${comment.text}</p>
                                <span>${new Date(comment.timestamp).toLocaleString()}</span>
                            </div>
                        `).join('');
                        commentsContainer.innerHTML += hiddenComments;
                        button.remove(); // Remove the "Show more" button after displaying the hidden comments
                    });
                });
            }

            function addCommentToDOM(postId, comment) {
                const commentsContainer = document.getElementById(`comments-${postId}`);
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                commentElement.innerHTML = `
                    <p>${comment.user}: ${comment.text}</p>
                    <span>${new Date(comment.timestamp).toLocaleString()}</span>
                `;
                commentsContainer.appendChild(commentElement);
            }

            function addNotification(message) {
                const notificationList = document.getElementById('notification-list');
                const notificationCount = document.getElementById('notification-count');
                const newNotification = document.createElement('li');
                newNotification.textContent = message;
                notificationList.prepend(newNotification);
                notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
            }

            // Cargar publicaciones existentes al iniciar
            fetch('/getPosts?category=emprendimientos')
                .then(response => response.json())
                .then(posts => {
                    posts.forEach(post => addPostToDOM(post));
                });
        });

        function logout() {
            fetch('/logout', {
            method: 'POST',
            }).then(response => {
            if (response.ok) {
                window.location.href = '/login.html';
            }
            }).catch(error => {
            console.error('Error al cerrar sesión:', error);
            });
            }

     async function loadProfilePhoto() {
        try {
            const response = await fetch('/currentUser');
            if (response.ok) {
                const user = await response.json();
                // Asigna la foto de perfil si existe, de lo contrario usa la imagen predeterminada
                document.getElementById('header-photo').src = user.photo || 'images/usuario.png';
            }
        } catch (error) {
            console.error('Error al cargar la foto de perfil:', error);
        }
     }

     document.addEventListener('DOMContentLoaded', loadProfilePhoto);
    </script>
</body>
</html>
